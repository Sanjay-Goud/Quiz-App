<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4f46e5;
            --primary-dark: #4338ca;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --border-color: #e5e7eb;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Navigation */
        nav {
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-dark);
            text-decoration: none;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger-color);
            color: var(--white);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
        }

        /* Quiz */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .question-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .question-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }

        .option {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }

        .option.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: var(--white);
        }

        .option input[type="radio"] {
            margin-right: 0.75rem;
            width: auto;
        }

        /* Quiz Navigation */
        .quiz-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            gap: 1rem;
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Score Display */
        .score-display {
            text-align: center;
            padding: 3rem;
        }

        .score-value {
            font-size: 4rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 1rem 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--white);
                padding: 1rem;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

            .nav-links.active {
                display: flex;
            }

            .mobile-menu-btn {
                display: block;
            }

            .quiz-nav {
                flex-direction: column;
            }

            table {
                font-size: 0.875rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-section select {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav>
    <div class="nav-container">
        <div class="logo">Quiz App</div>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>
        <ul class="nav-links" id="navLinks">
            <li><a onclick="showPage('home')">Home</a></li>
            <li id="navQuizzes" class="hidden"><a onclick="showPage('quizzes')">Quizzes</a></li>
            <li id="navAdmin" class="hidden"><a onclick="showPage('admin')">Admin</a></li>
            <li id="navLogin"><a onclick="showPage('login')">Login</a></li>
            <li id="navRegister"><a onclick="showPage('register')">Register</a></li>
            <li id="navLogout" class="hidden"><a onclick="logout()">Logout</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <!-- Home Page -->
    <div id="homePage">
        <div class="card">
            <h1>Welcome to Quiz Application</h1>
            <p>Test your knowledge with our interactive quizzes!</p>
            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" onclick="showPage('login')">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="hidden">
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <h2 class="card-header">Login</h2>
            <div id="loginAlert"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span id="loginBtnText">Login</span>
                </button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                Don't have an account? <a href="#" onclick="showPage('register')" style="color: var(--primary-color);">Register</a>
            </p>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="hidden">
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <h2 class="card-header">Register</h2>
            <div id="registerAlert"></div>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" required minlength="3">
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="regRole">Role</label>
                    <select id="regRole">
                        <option value="USER">User</option>
                        <option value="ADMIN">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span id="registerBtnText">Register</span>
                </button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                Already have an account? <a href="#" onclick="showPage('login')" style="color: var(--primary-color);">Login</a>
            </p>
        </div>
    </div>

    <!-- Quizzes Page (User) -->
    <div id="quizzesPage" class="hidden">
        <div class="card">
            <h2 class="card-header">Start a Quiz</h2>
            <div id="quizSelectionAlert"></div>
            <form onsubmit="createAndStartQuiz(event)">
                <div class="form-group">
                    <label for="userQuizCategory">Category</label>
                    <input type="text" id="userQuizCategory" placeholder="e.g., Java, Python, DSA" required>
                </div>
                <div class="form-group">
                    <label for="userQuizDifficulty">Difficulty Level (Optional)</label>
                    <select id="userQuizDifficulty">
                        <option value="">Any</option>
                        <option value="Easy">Easy</option>
                        <option value="Medium">Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userNumQuestions">Number of Questions</label>
                    <input type="number" id="userNumQuestions" min="1" max="50" value="5" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span id="startQuizBtnText">Start Quiz</span>
                </button>
            </form>
        </div>

        <!-- OR Section -->
        <div class="card">
            <h2 class="card-header">Join Existing Quiz</h2>
            <p>If you already have a Quiz ID, enter it here:</p>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <input type="number" id="existingQuizId" placeholder="Enter Quiz ID" style="flex: 1;">
                <button class="btn btn-secondary" onclick="loadExistingQuiz()">Load Quiz</button>
            </div>
        </div>
    </div>

    <!-- Quiz Attempt Page -->
    <div id="quizPage" class="hidden">
        <div class="quiz-container">
            <div id="quizHeader" class="card">
                <h2 id="quizTitle"></h2>
                <p>Question <span id="currentQ">1</span> of <span id="totalQ">0</span></p>
            </div>
            <div id="questionContainer"></div>
            <div class="quiz-nav">
                <button class="btn btn-outline" onclick="previousQuestion()" id="prevBtn">Previous</button>
                <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">Next</button>
                <button class="btn btn-secondary hidden" onclick="submitQuiz()" id="submitBtn">Submit Quiz</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="hidden">
        <!-- Add Question Section -->
        <div class="card">
            <h2 class="card-header">Add New Question</h2>
            <div id="addQuestionAlert"></div>
            <form onsubmit="handleAddQuestion(event)">
                <div class="form-group">
                    <label for="questionTitle">Question</label>
                    <textarea id="questionTitle" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="option1">Option 1</label>
                    <input type="text" id="option1" required>
                </div>
                <div class="form-group">
                    <label for="option2">Option 2</label>
                    <input type="text" id="option2" required>
                </div>
                <div class="form-group">
                    <label for="option3">Option 3</label>
                    <input type="text" id="option3" required>
                </div>
                <div class="form-group">
                    <label for="option4">Option 4</label>
                    <input type="text" id="option4" required>
                </div>
                <div class="form-group">
                    <label for="answer">Correct Answer</label>
                    <input type="text" id="answer" required>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <input type="text" id="category" required>
                </div>
                <div class="form-group">
                    <label for="difficultyLevel">Difficulty Level</label>
                    <select id="difficultyLevel">
                        <option value="Easy">Easy</option>
                        <option value="Medium">Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Question</button>
            </form>
        </div>

        <!-- View Questions Section -->
        <div class="card">
            <h2 class="card-header">All Questions</h2>
            <div class="filter-section">
                <select id="categoryFilter" onchange="filterQuestions()">
                    <option value="">All Categories</option>
                </select>
                <button class="btn btn-primary" onclick="loadQuestions()">Refresh</button>
            </div>
            <div id="questionsTable"></div>
        </div>

        <!-- Create Quiz Section -->
        <div class="card">
            <h2 class="card-header">Create Quiz</h2>
            <div id="createQuizAlert"></div>
            <form onsubmit="handleCreateQuiz(event)">
                <div class="form-group">
                    <label for="quizTitle">Quiz Title</label>
                    <input type="text" id="quizTitle" required>
                </div>
                <div class="form-group">
                    <label for="quizCategory">Category</label>
                    <input type="text" id="quizCategory" required>
                </div>
                <div class="form-group">
                    <label for="numQuestions">Number of Questions</label>
                    <input type="number" id="numQuestions" min="1" required>
                </div>
                <button type="submit" class="btn btn-secondary">Create Quiz</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Configuration - Update these based on your backend setup
    const API_BASE = 'http://localhost:8080'; // Question Service
    const AUTH_API = 'http://localhost:8082'; // Auth Service
    const QUIZ_API = 'http://localhost:8081'; // Quiz Service

    // Enable detailed error logging
    console.log('Frontend initialized with API endpoints:', { API_BASE, AUTH_API, QUIZ_API });

    // State
    let currentUser = null;
    let currentQuiz = null;
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let allQuestions = [];

    // Initialize
    window.onload = function() {
        checkAuth();
    };

    function checkAuth() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        const username = localStorage.getItem('username');

        if (token && role && username) {
            currentUser = { token, role, username };
            updateNavigation();
            showPage('home');
        } else {
            showPage('home');
        }
    }

    function updateNavigation() {
        if (currentUser) {
            document.getElementById('navLogin').classList.add('hidden');
            document.getElementById('navRegister').classList.add('hidden');
            document.getElementById('navLogout').classList.remove('hidden');
            document.getElementById('navQuizzes').classList.remove('hidden');

            if (currentUser.role === 'ADMIN') {
                document.getElementById('navAdmin').classList.remove('hidden');
            }
        } else {
            document.getElementById('navLogin').classList.remove('hidden');
            document.getElementById('navRegister').classList.remove('hidden');
            document.getElementById('navLogout').classList.add('hidden');
            document.getElementById('navQuizzes').classList.add('hidden');
            document.getElementById('navAdmin').classList.add('hidden');
        }
    }

    function showPage(page) {
        const pages = ['homePage', 'loginPage', 'registerPage', 'quizzesPage', 'quizPage', 'adminPage'];
        pages.forEach(p => document.getElementById(p).classList.add('hidden'));

        if (page === 'admin' && (!currentUser || currentUser.role !== 'ADMIN')) {
            showAlert('loginAlert', 'You must be an admin to access this page', 'error');
            showPage('login');
            return;
        }

        if ((page === 'quizzes' || page === 'admin') && !currentUser) {
            showAlert('loginAlert', 'Please login to continue', 'error');
            showPage('login');
            return;
        }

        document.getElementById(page + 'Page').classList.remove('hidden');

        if (page === 'admin') {
            loadQuestions();
            loadCategories();
        } else if (page === 'quizzes') {
            loadQuizzes();
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        document.getElementById('loginBtnText').innerHTML = '<span class="loading"></span> Logging in...';

        try {
            const response = await fetch(`${AUTH_API}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (data.success) {
                localStorage.setItem('token', data.data.accessToken);
                localStorage.setItem('role', data.data.userInfo.role);
                localStorage.setItem('username', data.data.userInfo.username);
                currentUser = {
                    token: data.data.accessToken,
                    role: data.data.userInfo.role,
                    username: data.data.userInfo.username
                };
                updateNavigation();
                showAlert('loginAlert', 'Login successful!', 'success');
                // Redirect based on role
                setTimeout(() => {
                    if (data.data.userInfo.role === 'ADMIN') {
                        showPage('admin');
                    } else {
                        showPage('quizzes');
                    }
                }, 1000);
            } else {
                showAlert('loginAlert', data.message || 'Login failed', 'error');
            }
        } catch (error) {
            showAlert('loginAlert', 'Network error. Please try again.', 'error');
        } finally {
            document.getElementById('loginBtnText').textContent = 'Login';
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        const username = document.getElementById('regUsername').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const role = document.getElementById('regRole').value;

        document.getElementById('registerBtnText').innerHTML = '<span class="loading"></span> Registering...';

        try {
            const response = await fetch(`${AUTH_API}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password, role })
            });

            const data = await response.json();

            if (data.success) {
                showAlert('registerAlert', 'Registration successful! Redirecting to login...', 'success');
                setTimeout(() => showPage('login'), 2000);
            } else {
                showAlert('registerAlert', data.message || 'Registration failed', 'error');
            }
        } catch (error) {
            showAlert('registerAlert', 'Network error. Please try again.', 'error');
        } finally {
            document.getElementById('registerBtnText').textContent = 'Register';
        }
    }

    function logout() {
        localStorage.clear();
        currentUser = null;
        updateNavigation();
        showPage('home');
    }

    async function handleAddQuestion(e) {
        e.preventDefault();
        const question = {
            questionTitle: document.getElementById('questionTitle').value,
            option1: document.getElementById('option1').value,
            option2: document.getElementById('option2').value,
            option3: document.getElementById('option3').value,
            option4: document.getElementById('option4').value,
            answer: document.getElementById('answer').value,
            category: document.getElementById('category').value,
            difficultyLevel: document.getElementById('difficultyLevel').value
        };

        try {
            const response = await fetch(`${API_BASE}/question/addQuestion`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify(question)
            });

            if (response.ok) {
                showAlert('addQuestionAlert', 'Question added successfully!', 'success');
                e.target.reset();
                loadQuestions();
            } else {
                showAlert('addQuestionAlert', 'Failed to add question', 'error');
            }
        } catch (error) {
            showAlert('addQuestionAlert', 'Network error', 'error');
        }
    }

    async function loadQuestions() {
        try {
            const response = await fetch(`${API_BASE}/question/allQuestions`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });

            allQuestions = await response.json();
            displayQuestions(allQuestions);
        } catch (error) {
            console.error('Error loading questions:', error);
        }
    }

    function displayQuestions(questions) {
        const container = document.getElementById('questionsTable');
        if (questions.length === 0) {
            container.innerHTML = '<p>No questions found.</p>';
            return;
        }

        let html = '<table><thead><tr><th>Question</th><th>Category</th><th>Difficulty</th><th>Answer</th></tr></thead><tbody>';
        questions.forEach(q => {
            html += `<tr>
                <td>${q.questionTitle}</td>
                <td>${q.category || 'N/A'}</td>
                <td>${q.difficultyLevel || 'N/A'}</td>
                <td>${q.answer}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function loadCategories() {
        const categories = [...new Set(allQuestions.map(q => q.category).filter(c => c))];
        const select = document.getElementById('categoryFilter');
        select.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
    }

    function filterQuestions() {
        const category = document.getElementById('categoryFilter').value;
        if (category) {
            const filtered = allQuestions.filter(q => q.category === category);
            displayQuestions(filtered);
        } else {
            displayQuestions(allQuestions);
        }
    }

    async function handleCreateQuiz(e) {
        e.preventDefault();
        const quiz = {
            title: document.getElementById('quizTitle').value,
            category: document.getElementById('quizCategory').value,
            noOfQ: parseInt(document.getElementById('numQuestions').value)
        };

        try {
            const response = await fetch(`${QUIZ_API}/quiz/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify(quiz)
            });

            if (response.ok) {
                const result = await response.text();
                showAlert('createQuizAlert', result, 'success');
                e.target.reset();
            } else {
                showAlert('createQuizAlert', 'Failed to create quiz', 'error');
            }
        } catch (error) {
            showAlert('createQuizAlert', 'Network error', 'error');
        }
    }

    async function loadQuizzes() {
        // Quiz selection form is already rendered in HTML
    }

    async function createAndStartQuiz(e) {
        e.preventDefault();

        const category = document.getElementById('userQuizCategory').value;
        const numQuestions = parseInt(document.getElementById('userNumQuestions').value);
        const title = `${category} Quiz - ${new Date().toLocaleString()}`;

        document.getElementById('startQuizBtnText').innerHTML = '<span class="loading"></span> Creating Quiz...';

        try {
            // Step 1: Create the quiz
            const createResponse = await fetch(`${QUIZ_API}/quiz/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify({
                    title: title,
                    category: category,
                    noOfQ: numQuestions
                })
            });

            if (!createResponse.ok) {
                const errorText = await createResponse.text();
                throw new Error(errorText || 'Failed to create quiz');
            }

            const resultText = await createResponse.text();

            // Extract quiz ID from response (format: "Quiz created successfully with ID: X")
            const quizIdMatch = resultText.match(/ID:\s*(\d+)/);

            if (quizIdMatch && quizIdMatch[1]) {
                const quizId = quizIdMatch[1];
                showAlert('quizSelectionAlert', 'Quiz created! Loading questions...', 'success');

                // Step 2: Load the quiz
                setTimeout(() => {
                    loadQuizById(quizId, title);
                }, 500);
            } else {
                throw new Error('Could not extract quiz ID from response');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('quizSelectionAlert', error.message || 'Failed to create quiz. Make sure questions exist for this category.', 'error');
        } finally {
            document.getElementById('startQuizBtnText').textContent = 'Start Quiz';
        }
    }

    async function loadExistingQuiz() {
        const quizId = document.getElementById('existingQuizId').value;
        if (!quizId) {
            showAlert('quizSelectionAlert', 'Please enter a Quiz ID', 'error');
            return;
        }
        await loadQuizById(quizId, `Quiz #${quizId}`);
    }

    async function loadQuizById(quizId, title) {
        try {
            const response = await fetch(`${QUIZ_API}/quiz/get/${quizId}`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });

            if (!response.ok) {
                throw new Error('Quiz not found');
            }

            currentQuiz = await response.json();

            if (currentQuiz && currentQuiz.length > 0) {
                currentQuestionIndex = 0;
                userAnswers = {};
                currentQuiz.quizId = quizId; // Store quiz ID for submission
                document.getElementById('quizTitle').textContent = title;
                document.getElementById('quizHeader').style.display = 'block';
                document.querySelector('.quiz-nav').style.display = 'flex';
                showPage('quiz');
                displayQuestion();
            } else {
                throw new Error('Quiz has no questions');
            }
        } catch (error) {
            showAlert('quizSelectionAlert', error.message || 'Error loading quiz', 'error');
        }
    }

    function displayQuestion() {
        if (!currentQuiz || currentQuiz.length === 0) return;

        const question = currentQuiz[currentQuestionIndex];
        document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
        document.getElementById('totalQ').textContent = currentQuiz.length;

        const container = document.getElementById('questionContainer');
        const selectedAnswer = userAnswers[question.id] || '';

        container.innerHTML = `
            <div class="question-card">
                <div class="question-header">${question.questionTitle}</div>
                <div class="option ${selectedAnswer === question.option1 ? 'selected' : ''}" onclick="selectAnswer(${question.id}, '${question.option1}')">
                    <input type="radio" name="answer" ${selectedAnswer === question.option1 ? 'checked' : ''}> ${question.option1}
                </div>
                <div class="option ${selectedAnswer === question.option2 ? 'selected' : ''}" onclick="selectAnswer(${question.id}, '${question.option2}')">
                    <input type="radio" name="answer" ${selectedAnswer === question.option2 ? 'checked' : ''}> ${question.option2}
                </div>
                <div class="option ${selectedAnswer === question.option3 ? 'selected' : ''}" onclick="selectAnswer(${question.id}, '${question.option3}')">
                    <input type="radio" name="answer" ${selectedAnswer === question.option3 ? 'checked' : ''}> ${question.option3}
                </div>
                <div class="option ${selectedAnswer === question.option4 ? 'selected' : ''}" onclick="selectAnswer(${question.id}, '${question.option4}')">
                    <input type="radio" name="answer" ${selectedAnswer === question.option4 ? 'checked' : ''}> ${question.option4}
                </div>
            </div>
        `;

        // Update navigation buttons
        document.getElementById('prevBtn').style.display = currentQuestionIndex === 0 ? 'none' : 'inline-block';
        document.getElementById('nextBtn').style.display = currentQuestionIndex === currentQuiz.length - 1 ? 'none' : 'inline-block';
        document.getElementById('submitBtn').classList.toggle('hidden', currentQuestionIndex !== currentQuiz.length - 1);
    }

    function selectAnswer(questionId, answer) {
        userAnswers[questionId] = answer;
        displayQuestion();
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayQuestion();
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < currentQuiz.length - 1) {
            currentQuestionIndex++;
            displayQuestion();
        }
    }

    async function submitQuiz() {
        if (Object.keys(userAnswers).length < currentQuiz.length) {
            if (!confirm('You have not answered all questions. Submit anyway?')) {
                return;
            }
        }

        const responses = currentQuiz.map(q => ({
            id: q.id,
            response: userAnswers[q.id] || ''
        }));

        // Use the stored quiz ID
        const quizId = currentQuiz.quizId;

        if (!quizId) {
            alert('Quiz ID not found. Please try again.');
            return;
        }

        try {
            const response = await fetch(`${QUIZ_API}/quiz/submit/${quizId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify(responses)
            });

            if (!response.ok) {
                throw new Error('Failed to submit quiz');
            }

            const score = await response.json();
            displayScore(score, currentQuiz.length);
        } catch (error) {
            alert('Error submitting quiz: ' + error.message);
        }
    }

    function displayScore(score, total) {
        const percentage = Math.round((score / total) * 100);
        document.getElementById('questionContainer').innerHTML = `
            <div class="score-display">
                <h2>Quiz Completed!</h2>
                <div class="score-value">${score}/${total}</div>
                <p style="font-size: 1.5rem; color: var(--text-light);">${percentage}%</p>
                <button class="btn btn-primary" onclick="showPage('quizzes')" style="margin-top: 2rem;">Take Another Quiz</button>
            </div>
        `;
        document.getElementById('quizHeader').style.display = 'none';
        document.querySelector('.quiz-nav').style.display = 'none';
    }

    function showAlert(elementId, message, type) {
        const alertDiv = document.getElementById(elementId);
        alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
            alertDiv.innerHTML = '';
        }, 5000);
    }

    function toggleMobileMenu() {
        document.getElementById('navLinks').classList.toggle('active');
    }
</script>
</body>
</html>